# Hotel Management System - Микросервисная архитектура

Проект управления отелями и бронирования номеров с распределенной архитектурой. 

## Технологический стек

- Java 17
- Spring Boot 3.3.5
- Spring Cloud 2023.0.3
- Spring Security + JWT
- Spring Data JPA + H2 (in-memory)
- Spring Cloud Gateway
- Spring Cloud Netflix Eureka
- OpenFeign для межсервисного взаимодействия
- Spring Retry для устойчивости
- Lombok
- JUnit 5 + MockMvc

## Архитектура системы

Система состоит из 4 модулей:

1. **Service Discovery**  - Service Discovery
2. **Gateway** - Точка входа, маршрутизация
3. **Hotel Management** - Управление отелями и номерами
4. **Booking** - Бронирования, аутентификация пользователей

Сперва запускается Service Discovery, затем сервисы, затем маршрутизация через Gateway.

В проекте добавлен swagger, написаны интеграционные тесты, реализована аутентификация пользователей 
через oauth2 resource server по канонам последнего спринга.   

В качестве БД используется H2 - in-memory.
Распределение по номерам равномерное, завязывается на количество заселений.

Обеспечена идемпотентность запросов

## Алгоритм распределения номеров

- Каждый номер имеет счётчик `timesBooked`
- Рекомендации сортируются по:
    1. `timesBooked` (по возрастанию)
    2. `id`
- При `autoSelect = true` выбирается наименее загруженный номер

---

## Процесс бронирования (Saga)

1. **PENDING** — создание бронирования
2. **Confirm** — `POST /api/rooms/{id}/confirm-availability`
3. **CONFIRMED** — успешное завершение
4. **CANCELLED** - отмена бронирования
    - статус `CANCELLED`
    - `POST /api/rooms/{id}/release`

---

## Устойчивость и Retry

- `@Retryable` с экспоненциальным backoff
- 3 попытки
- Интервал: 500 ms × 2
- Таймаут Feign — 2 секунды
- При ошибке выполняется компенсация

---

## Идемпотентность

- Каждый запрос содержит `requestId`
- Повторные запросы игнорируются
- Предотвращает дублирование операций

---

## Трассировка

- Gateway добавляет заголовок `operUid`
- Используется `bookingId` для трассировки саги
- Все ключевые этапы логируются

---

## Безопасность

- JWT с TTL 1 час
- Роли: USER, ADMIN
- Resource Server pattern
- `@PreAuthorize`
- HTTP 401 / 403

# Предзаполнение данных 

Есть предзаполнение данных с помощью DataSeeder классов